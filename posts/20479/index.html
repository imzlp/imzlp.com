<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-tilt-brush.png">
  <link rel="mask-icon" href="/images/favicon-32x32-tilt-brush.png" color="#222">
  <meta name="google-site-verification" content="ttIkhAIFZQM9Huj8roB0l95ePN2Tv2zv2wRFksi09WA">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Pacifico:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/5.15.2/css/all.min.css">
  <link rel="stylesheet" href="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"imzlp.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false,"width":280},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"manual"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"code_unfold":{"enable":true,"CODE_MAX_HEIGHT":600},"path":"search.xml"};
  </script>

  <meta name="description" content="IR代码是LLVM生成的Intermediate Code。可以通过IR代码来分析编译器对我们所写的代码是如何解析并执行的，使得分析代码语义变得简洁明了。IR代码的语法语义可参考LLVM Language Reference Manual。">
<meta property="og:type" content="article">
<meta property="og:title" content="通过IR代码来分析C++代码语义">
<meta property="og:url" content="https://imzlp.com/posts/20479/index.html">
<meta property="og:site_name" content="循迹研究室">
<meta property="og:description" content="IR代码是LLVM生成的Intermediate Code。可以通过IR代码来分析编译器对我们所写的代码是如何解析并执行的，使得分析代码语义变得简洁明了。IR代码的语法语义可参考LLVM Language Reference Manual。">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2017-03-08T11:46:55.000Z">
<meta property="article:modified_time" content="2017-03-08T11:46:55.000Z">
<meta property="article:author" content="查利鹏">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="编程笔记">
<meta property="article:tag" content="中间代码">
<meta property="article:tag" content="LLVM-IR">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://imzlp.com/posts/20479/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>通过IR代码来分析C++代码语义 | 循迹研究室</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDCJ41EFP5"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FDCJ41EFP5');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" /><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="循迹研究室" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">循迹研究室</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        
            
  <li class="menu-item menu-item-notes">

    <a href="/notes/" rel="section"><i class="fa fa-edit fa-fw"></i>笔记</a>

  </li>


      
        
            
  <li class="menu-item menu-item-essay">

    <a href="/essay/" rel="section"><i class="fas fa-feather-alt fa-fw"></i>随笔</a>

  </li>


      
        
            
  <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-inbox fa-fw"></i>资源</a>

  </li>


      
        <li class="menu-item menu-item-friends">

    <a href="/friends/" rel="section"><i class="fas fa-link fa-fw"></i>友链</a>

  </li>
        
            
  <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>


      
        <li class="menu-item menu-item-showcase">

    <a href="/showcase/" rel="section"><i class="fa fa-solid fa-trophy fa-fw"></i>展示柜</a>

  </li>
        <li class="menu-item menu-item-changelog">

    <a href="/changelog/" rel="section"><i class="fa fa-history fa-fw"></i>站点日志</a>

  </li>
        <li class="menu-item menu-item-opensource">

    <a href="/opensource/" rel="section"><i class="fas fa-code-branch fa-fw"></i>开源项目</a>

  </li>
        <li class="menu-item menu-item-uewiki">

    <a href="https://ue5wiki.com/" rel="noopener" target="_blank"><i class="fab fa-wikipedia-w fa-fw"></i>虚幻知识库</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>站内搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>



<script type="text/javascript">
  let domain='aW16bHAuY29t';
  let domain_str = atob(domain);
  let pathname = location.pathname;
  if (domain_str!= location.host.toLowerCase()){
        console.log(`this host is not safe,jump to https://${domain_str}${pathname}`);
        location.href=`https://${domain_str}${pathname}`;
  }
</script>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"
  >
    <link itemprop="mainEntityOfPage" href="https://imzlp.com/posts/20479/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
      <meta itemprop="name" content="查利鹏">
      <meta itemprop="description" content="唯有热爱可抵岁月漫长。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="循迹研究室">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          通过IR代码来分析C++代码语义<a href="https://github.com/imzlp/blog-md/blob/master/_posts/2017-03-08-20479.md" class="post-edit-link" title="编辑" style="float: right;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a>
        </h1>

        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2017-03-08 11:46 11:46:55:46" itemprop="dateCreated datePublished" datetime="2017-03-08T11:46:55+00:00">2017-03-08 11:46</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E7%BC%96%E7%A8%8B%E5%B7%A5%E5%85%B7/" itemprop="url" rel="index"><span itemprop="name">编程工具</span></a>
                </span>
            </span>

          
            <span id="/posts/20479/" class="post-meta-item leancloud_visitors" data-flag-title="通过IR代码来分析C++代码语义" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>2k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>5 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>IR代码是LLVM生成的<code>Intermediate Code</code>。可以通过IR代码来分析编译器对我们所写的代码是如何解析并执行的，使得分析代码语义变得简洁明了。IR代码的语法语义可参考<a target="_blank" rel="noopener" href="http://llvm.org/docs/LangRef.html#store-instruction">LLVM Language Reference Manual</a>。</p>
<span id="more"></span>

<p>通过Clang/LLVM生成IR代码的命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang++ -S -emit-llvm source.cpp</span><br></pre></td></tr></table></figure>

<p>则会生成一个source.ll文件，即是我们需要分析的IR代码。</p>
<p>先从一个最简单的示例开始：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> x;</span><br><span class="line">cout&lt;&lt;x&lt;&lt;endl;</span><br></pre></td></tr></table></figure>

<p>我们都知道，如果一个位于<strong>automatic/dynamic storage duration</strong>的对象没有被初始化则具有不确定的值。</p>
<blockquote>
<p>If no initializer is specified for an object, the object is default-initialized. When storage for an object with automatic or dynamic storage duration is obtained, the object has an indeterminate value, and if no initialization is performed for the object, that object retains an indeterminate value until that value is replaced (5.17).</p>
</blockquote>
<p>那么编译器是如何做的呢？看以下中间代码，为节省篇幅省去不必要的部分。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">2</span> = alloca i32, align <span class="number">4</span></span><br><span class="line">%<span class="number">3</span> = load i32, i32* %<span class="number">2</span>, align <span class="number">4</span></span><br><span class="line">%<span class="number">4</span> = call <span class="built_in">dereferenceable</span>(<span class="number">272</span>) %<span class="string">&quot;class.std::basic_ostream&quot;</span>* @_ZNSolsEi(%<span class="string">&quot;class.std::basic_ostream&quot;</span>* @_ZSt4cout, i32 %<span class="number">3</span>)</span><br><span class="line">%<span class="number">5</span> = call <span class="built_in">dereferenceable</span>(<span class="number">272</span>) %<span class="string">&quot;class.std::basic_ostream&quot;</span>* @_ZNSolsEPFRSoS_E(%<span class="string">&quot;class.std::basic_ostream&quot;</span>* %<span class="number">4</span>, %<span class="string">&quot;class.std::basic_ostream&quot;</span>* (%<span class="string">&quot;class.std::basic_ostream&quot;</span>*)* @_ZSt4endlIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6_)</span><br></pre></td></tr></table></figure>

<p>可以看到，声明(和定义区别看<a href="https://imzlp.com/posts/21831/">C++中declaration与define的区别</a>)一个automatic的int型对象并输出执行了以下几步：</p>
<ol>
<li>分配一个i32的空间,%2</li>
<li>加载该空间的地址,%3</li>
<li>然后%4和%5是调用cout输出%3的那块内存</li>
</ol>
<p>注意：这里并没有对分配的那块内存做任何操作，所以对其取值得到的值是不确定的。</p>
<p>来对比一下带有初始化的操作：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> x=<span class="number">111</span>;</span><br><span class="line">cout&lt;&lt;x&lt;&lt;endl;</span><br></pre></td></tr></table></figure>

<p>其IR代码为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">2</span> = alloca i32, align <span class="number">4</span></span><br><span class="line">store i32 <span class="number">111</span>, i32* %<span class="number">2</span>, align <span class="number">4</span></span><br><span class="line">%<span class="number">3</span> = load i32, i32* %<span class="number">2</span>, align <span class="number">4</span></span><br><span class="line">%<span class="number">4</span> = call <span class="built_in">dereferenceable</span>(<span class="number">272</span>) %<span class="string">&quot;class.std::basic_ostream&quot;</span>* @_ZNSolsEi(%<span class="string">&quot;class.std::basic_ostream&quot;</span>* @_ZSt4cout, i32 %<span class="number">3</span>)</span><br><span class="line">%<span class="number">5</span> = call <span class="built_in">dereferenceable</span>(<span class="number">272</span>) %<span class="string">&quot;class.std::basic_ostream&quot;</span>* @_ZNSolsEPFRSoS_E(%<span class="string">&quot;class.std::basic_ostream&quot;</span>* %<span class="number">4</span>, %<span class="string">&quot;class.std::basic_ostream&quot;</span>* (%<span class="string">&quot;class.std::basic_ostream&quot;</span>*)* @_ZSt4endlIcSt11char_traitsIcEERSt13basic_ostreamIT_T0_ES6_)</span><br></pre></td></tr></table></figure>

<p>注意增加的第二行：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">store i32 <span class="number">111</span>, i32* %<span class="number">2</span>, align <span class="number">4</span></span><br></pre></td></tr></table></figure>

<p>这句代表存储i32值111到i32* %2所指向的空间。</p>
<p>再来分析一个示例：给数组的部分元素初始化，是否会初始化未被初始化的元素？</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> iarr[<span class="number">123</span>]=&#123;<span class="number">111</span>,<span class="number">222</span>,<span class="number">333</span>&#125;;</span><br></pre></td></tr></table></figure>

<p>当然这个我们是知道的，因为标准规定如下：</p>
<blockquote>
<p><strong>[ISO/IEC 14882:2014]</strong></p>
</blockquote>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">float</span> y[<span class="number">4</span>][<span class="number">3</span>] = &#123;&#123; <span class="number">1</span> &#125;, &#123; <span class="number">2</span> &#125;, &#123; <span class="number">3</span> &#125;, &#123; <span class="number">4</span> &#125;&#125;;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>initializes the first column of y (regarded as a two-dimensional array) and leaves the rest zero.<br><strong>[ISO/IEC 9899:1999]</strong><br>If there are fewer initializers in a brace-enclosed list than there are elements or members of an aggregate, or fewer characters in a string literal used to initialize an array of known size than there are elements in the array, the remainder of the aggregate shall be initialized implicitly the same as objects that have static storage duration.</p>
</blockquote>
<p>那么，编译器是如何做的呢？其IR代码如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">2</span> = alloca [<span class="number">123</span> x i32], align <span class="number">16</span></span><br><span class="line">%<span class="number">3</span> = bitcast [<span class="number">123</span> x i32]* %<span class="number">2</span> to i8*</span><br><span class="line">call <span class="type">void</span> @llvm.memset.p0i8.<span class="built_in">i64</span>(i8* %<span class="number">3</span>, i8 <span class="number">0</span>, i64 <span class="number">492</span>, i32 <span class="number">16</span>, i1 <span class="literal">false</span>)</span><br><span class="line">%<span class="number">4</span> = bitcast i8* %<span class="number">3</span> to [<span class="number">123</span> x i32]*</span><br><span class="line"><span class="comment">// 下标访问，执行赋值操作</span></span><br><span class="line">%<span class="number">5</span> = getelementptr [<span class="number">123</span> x i32], [<span class="number">123</span> x i32]* %<span class="number">4</span>, i32 <span class="number">0</span>, i32 <span class="number">0</span></span><br><span class="line">store i32 <span class="number">111</span>, i32* %<span class="number">5</span></span><br><span class="line">%<span class="number">6</span> = getelementptr [<span class="number">123</span> x i32], [<span class="number">123</span> x i32]* %<span class="number">4</span>, i32 <span class="number">0</span>, i32 <span class="number">1</span></span><br><span class="line">store i32 <span class="number">222</span>, i32* %<span class="number">6</span></span><br><span class="line">%<span class="number">7</span> = getelementptr [<span class="number">123</span> x i32], [<span class="number">123</span> x i32]* %<span class="number">4</span>, i32 <span class="number">0</span>, i32 <span class="number">2</span></span><br><span class="line">store i32 <span class="number">333</span>, i32* %<span class="number">7</span></span><br></pre></td></tr></table></figure>

<ol>
<li>首先，先分配了一个123*i32大小的空间,%2</li>
<li>将上面分配空间的地址转换为一个指针i8*,%3(数组的起始地址)</li>
<li>调用memset对%2空间的每一个字节(i8)都置为0，从%3位置起始往后偏移123*i32=492 byte</li>
<li>依次通过数组起始地址来访问下标为0(%4),1(%5),2(%6)元素的地址</li>
<li>依次存储初始化列表中的值至该地址(111 to %4 / 222 to %5 / 333 to %6)\</li>
</ol>
<p>再来分析一下<a href="https://imzlp.com/posts/10205/#Q5">CppQuiz#Q5</a>这个例子吧，原题如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">AClass</span> &#123;</span><br><span class="line">  <span class="built_in">AClass</span>() &#123; std::cout &lt;&lt; <span class="string">&quot;AClass&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">BClass</span> &#123;</span><br><span class="line">  <span class="built_in">BClass</span>() &#123; std::cout &lt;&lt; <span class="string">&quot;BClass&quot;</span>; &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CClass</span> &#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">CClass</span>() : <span class="built_in">aobj</span>(), <span class="built_in">bobj</span>() &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  BClass bobj;</span><br><span class="line">  AClass aobj;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">CClass</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>问：在C++11下，该代码的执行结果。</p>
<p>假定现在我们不知道它会执行什么(解答可看上面的链接)，我们从IR代码角度来分析一下。<br>我们在主函中构造了一个CClass的临时对象，我们期望于CClass中对象的初始化顺序为aobj/bobj，但是事实是怎么样的呢？<br>IR代码如下(这里我们只需要看CClass的构造函数即可)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主函数</span></span><br><span class="line">; Function Attrs: norecurse uwtable</span><br><span class="line">define i32 @<span class="built_in">main</span>() #<span class="number">4</span> &#123;</span><br><span class="line">  %<span class="number">1</span> = alloca %<span class="keyword">class</span>.CClass, align <span class="number">1</span></span><br><span class="line">  call <span class="type">void</span> @_ZN6CClassC2Ev(%<span class="keyword">class</span>.CClass* %<span class="number">1</span>)</span><br><span class="line">  ret i32 <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// CClass的构造函数</span></span><br><span class="line">; Function Attrs: uwtable</span><br><span class="line">define linkonce_odr <span class="type">void</span> @_ZN6CClassC2Ev(%<span class="keyword">class</span>.CClass*) unnamed_addr #<span class="number">0</span> comdat align <span class="number">2</span> &#123;</span><br><span class="line">  %<span class="number">2</span> = alloca %<span class="keyword">class</span>.CClass*, align <span class="number">8</span></span><br><span class="line">  store %<span class="keyword">class</span>.CClass* %<span class="number">0</span>, %<span class="keyword">class</span>.CClass** %<span class="number">2</span>, align <span class="number">8</span></span><br><span class="line">  %<span class="number">3</span> = load %<span class="keyword">class</span>.CClass*, %<span class="keyword">class</span>.CClass** %<span class="number">2</span>, align <span class="number">8</span></span><br><span class="line">  %<span class="number">4</span> = getelementptr inbounds %<span class="keyword">class</span>.CClass, %<span class="keyword">class</span>.CClass* %<span class="number">3</span>, i32 <span class="number">0</span>, i32 <span class="number">0</span></span><br><span class="line">  call <span class="type">void</span> @_ZN6BClassC2Ev(%<span class="keyword">struct</span>.BClass* %<span class="number">4</span>)</span><br><span class="line">  %<span class="number">5</span> = getelementptr inbounds %<span class="keyword">class</span>.CClass, %<span class="keyword">class</span>.CClass* %<span class="number">3</span>, i32 <span class="number">0</span>, i32 <span class="number">1</span></span><br><span class="line">  call <span class="type">void</span> @_ZN6AClassC2Ev(%<span class="keyword">struct</span>.AClass* %<span class="number">5</span>)</span><br><span class="line">  ret <span class="type">void</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// BClass的构造函数</span></span><br><span class="line">; Function Attrs: uwtable</span><br><span class="line">define linkonce_odr <span class="type">void</span> @_ZN6BClassC2Ev(%<span class="keyword">struct</span>.BClass*) unnamed_addr #<span class="number">0</span> comdat align <span class="number">2</span> &#123;</span><br><span class="line">  %<span class="number">2</span> = alloca %<span class="keyword">struct</span>.BClass*, align <span class="number">8</span></span><br><span class="line">  store %<span class="keyword">struct</span>.BClass* %<span class="number">0</span>, %<span class="keyword">struct</span>.BClass** %<span class="number">2</span>, align <span class="number">8</span></span><br><span class="line">  %<span class="number">3</span> = load %<span class="keyword">struct</span>.BClass*, %<span class="keyword">struct</span>.BClass** %<span class="number">2</span>, align <span class="number">8</span></span><br><span class="line">  %<span class="number">4</span> = call <span class="built_in">dereferenceable</span>(<span class="number">272</span>) %<span class="string">&quot;class.std::basic_ostream&quot;</span>* @_ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc(%<span class="string">&quot;class.std::basic_ostream&quot;</span>* <span class="built_in">dereferenceable</span>(<span class="number">272</span>) @_ZSt4cout, i8* getelementptr <span class="built_in">inbounds</span> ([<span class="number">7</span> x i8], [<span class="number">7</span> x i8]* @.str, i32 <span class="number">0</span>, i32 <span class="number">0</span>))</span><br><span class="line">  ret <span class="type">void</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// AClass的构造函数</span></span><br><span class="line">; Function Attrs: uwtable</span><br><span class="line">define linkonce_odr <span class="type">void</span> @_ZN6AClassC2Ev(%<span class="keyword">struct</span>.AClass*) unnamed_addr #<span class="number">0</span> comdat align <span class="number">2</span> &#123;</span><br><span class="line">  %<span class="number">2</span> = alloca %<span class="keyword">struct</span>.AClass*, align <span class="number">8</span></span><br><span class="line">  store %<span class="keyword">struct</span>.AClass* %<span class="number">0</span>, %<span class="keyword">struct</span>.AClass** %<span class="number">2</span>, align <span class="number">8</span></span><br><span class="line">  %<span class="number">3</span> = load %<span class="keyword">struct</span>.AClass*, %<span class="keyword">struct</span>.AClass** %<span class="number">2</span>, align <span class="number">8</span></span><br><span class="line">  %<span class="number">4</span> = call <span class="built_in">dereferenceable</span>(<span class="number">272</span>) %<span class="string">&quot;class.std::basic_ostream&quot;</span>* @_ZStlsISt11char_traitsIcEERSt13basic_ostreamIcT_ES5_PKc(%<span class="string">&quot;class.std::basic_ostream&quot;</span>* <span class="built_in">dereferenceable</span>(<span class="number">272</span>) @_ZSt4cout, i8* getelementptr <span class="built_in">inbounds</span> ([<span class="number">7</span> x i8], [<span class="number">7</span> x i8]* @.str<span class="number">.1</span>, i32 <span class="number">0</span>, i32 <span class="number">0</span>))</span><br><span class="line">  ret <span class="type">void</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，虽然我们在CClass 的构造函数中写到(期望于先构造aobj再构造bobj)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">CClass</span>() : <span class="built_in">aobj</span>(), <span class="built_in">bobj</span>() &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>但是实际上编译器在构造CClass时的顺序为(先调用了BClass的构造函数，然后再调用了AClass的构造函数)：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">%<span class="number">4</span> = getelementptr inbounds %<span class="keyword">class</span>.CClass, %<span class="keyword">class</span>.CClass* %<span class="number">3</span>, i32 <span class="number">0</span>, i32 <span class="number">0</span></span><br><span class="line">call <span class="type">void</span> @_ZN6BClassC2Ev(%<span class="keyword">struct</span>.BClass* %<span class="number">4</span>)</span><br><span class="line">%<span class="number">5</span> = getelementptr inbounds %<span class="keyword">class</span>.CClass, %<span class="keyword">class</span>.CClass* %<span class="number">3</span>, i32 <span class="number">0</span>, i32 <span class="number">1</span></span><br><span class="line">call <span class="type">void</span> @_ZN6AClassC2Ev(%<span class="keyword">struct</span>.AClass* %<span class="number">5</span>)</span><br></pre></td></tr></table></figure>

<p>即，类在构造的时候不是按照类的初始化列表的顺序构造的，而是按照类中定义的次序构造的。</p>
<blockquote>
<p>[ISO/IEC 14882:2014]non-static data members are initialized in the order they were declared in the class definition(again regardless of the order of the mem-initializers).</p>
</blockquote>
<p>先简单写到这里，通过这样的方式来分析语义组合语言的标准文档，可以作为当代码出现底层的逻辑错误时分析的有力工具。</p>
<p>如果想要从IR代码编译到汇编代码可以使用<code>llc</code>:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ llc test.ll -o test.s</span><br></pre></td></tr></table></figure>

    </div>

    
    
        
        
          
            <blockquote class="blockquote-center">
              
                全文完，若有不足之处请评论指正。
              
            <br/>
            
                <div class="qr-code" onclick="return false">
                    <script src="/js/qrcode.min.js"></script>
                    <div id="qrcode">
                      
                        <img src="https://imzlp.com/images/wechat-qrcode.webp">
                      
                    <p>微信扫描二维码，关注我的公众号。</p>
                    </div>
                </div>
            
            </blockquote>
          
        

        
          <div class="postCopyright" style="clear:both;">
             <span>本文标题:</span><a href="/posts/20479/" target="_blank">通过IR代码来分析C++代码语义</a><br/>
             <span>文章作者:</span><a href="/about" target="_blank" title="查看 查利鹏 的资料">查利鹏</a><br/>
             <span>发布时间:</span>2017年03月08日 11时46分<br/>
             
             <span>本文字数:</span><span class="page-count">本文一共有2k字</span><br/>
             
             <span>原始链接:</span><a href="/posts/20479/" target="_blank" title="通过IR代码来分析C++代码语义">https://imzlp.com/posts/20479/</a>
             <span class="copy-path" data-clipboard-text="原文链接: https://imzlp.com/posts/20479/ 作者: 查利鹏" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
             <script src="/js/jquery.min.js"></script>
             <script src="/js/clipboard.min.js"></script>
             <script> var clipboard = new Clipboard('.copy-path'); </script>
             <br/>
             
             <span>许可协议:</span><i class="fab fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="Attribution-NonCommercial-ShareAlike 4.0 International">CC BY-NC-SA 4.0</a><br/>
             
             <span>文章禁止全文转载，摘要转发请保留原文链接及作者信息，谢谢！</span>
          </div>
        
    
        
  <div class="reward-container">
    <div>您的捐赠将鼓励我继续创作！</div>
    <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
      打赏
    </button>
    <div id="qr" style="display: none;">
        
        <div style="display: inline-block;">
          <img src="/images/reward/wechatpay.webp" alt="查利鹏 微信支付">
          <p>微信支付</p>
        </div>

    </div>
  </div>



      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/C/" rel="tag"># C++</a>
              <a href="/tags/%E7%BC%96%E7%A8%8B%E7%AC%94%E8%AE%B0/" rel="tag"># 编程笔记</a>
              <a href="/tags/%E4%B8%AD%E9%97%B4%E4%BB%A3%E7%A0%81/" rel="tag"># 中间代码</a>
              <a href="/tags/LLVM-IR/" rel="tag"># LLVM-IR</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/3276/" rel="prev" title="STL容器的迭代器失效">
      <i class="fa fa-chevron-left"></i> STL容器的迭代器失效
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/2658/" rel="next" title="fork/vfork浅谈">
      fork/vfork浅谈 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-utteranc">utteranc</a></li>
            <li class="tab"><a href="#comment-valine">valine</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane utteranc" id="comment-utteranc">
              
  
  <div class="comments">
  <script src="https://utteranc.es/client.js" repo="hxhb/blog-comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script>
  </div>
  
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person" oncontextmenu="return false" οndragstart="return false">
    <img class="site-author-image" itemprop="image" alt="查利鹏"
      src="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
  <p class="site-author-name" itemprop="name">查利鹏</p>
  <div class="site-description" itemprop="description">唯有热爱可抵岁月漫长。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
             
          <span class="site-state-item-count">189</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">94</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">188</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hxhb" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hxhb" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://linkedin.com/in/lipengzha" title="Linkedin → https:&#x2F;&#x2F;linkedin.com&#x2F;in&#x2F;lipengzha" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/imzlp" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;imzlp" rel="noopener" target="_blank"><i class="fa fa-custom zhihu fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/images/wechat-qrcode-offical.webp" title="微信公众号 → &#x2F;images&#x2F;wechat-qrcode-offical.webp"><i class="fab fa-weixin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:imzlp@foxmail.com" title="E-Mail → mailto:imzlp@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://consolehelp.imzlp.com/" title="https:&#x2F;&#x2F;consolehelp.imzlp.com&#x2F;" rel="noopener" target="_blank">UE Console Help</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/opensource/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;opensource&#x2F;">Open Source Projects</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/posts/11515/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;posts&#x2F;11515&#x2F;">UE C++ API Dash Documents</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ue5wiki.com/" title="https:&#x2F;&#x2F;ue5wiki.com&#x2F;" rel="noopener" target="_blank">Unreal Engine Wiki</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备2021027036号 </a>
      <img src="/images/beian_logo.webp" style="display: inline-block;"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44030502007298" rel="noopener" target="_blank">粤公网安备44030502007298号 </a>
  </div>

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">查利鹏</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">747k</span>
</div>
  <div class="powered-by-other">
    
	    <center>Github Pages | Actions | NeXT | Cloudflare | Hexo Deploy</center>
      
  </div>

<script>
function checkWebp(callback) {
    var img = new Image();
    img.onload = function () { callback((img.width > 0) && (img.height > 0)); };
    img.onerror = function () { callback(false); };
    img.src = 'data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA';
}
function showImage(useWebp) {
    var imgs = [].slice.call(document.querySelectorAll('img'));
    imgs.forEach(function (e) {
        if (!useWebp) {
            var src = e.getAttribute('data-src')
            src = src.replace(/\.webp$/, '.png');
            e.setAttribute('data-src', src);
        }
    });
}
checkWebp(showImage);
</script>

        








      </div>
    </footer>
  </div>

  
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/animejs/3.2.1/anime.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.5.1/jquery.min.js"></script>
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/lozad.js/1.16.0/lozad.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/pangu/4.0.7/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>



<script src="/js/code-unfold.js"></script>

  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

  
  <script src="//img.imzlp.com/imgs/zlp/picgo/2021/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://imzlp.com/posts/20479/',]
      });
      });
  </script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/valine/1.4.14/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    var requiredFields = 'nick';
    requiredFields = requiredFields.split(',');
    
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'oCE6RMVkVoi5MgUhvFsn1EvV-gzGzoHsz',
      appKey     : 'K9SOaNYJ8PV6xaoFggWG5xvv',
      placeholder: "留下点什么吧~",
      avatar     : 'robohash',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : '',
      requiredFields: requiredFields
    });
  }, window.Valine);
});
</script>

</body>
</html>
