<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-tilt-brush.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-tilt-brush.png">
  <link rel="mask-icon" href="/images/favicon-32x32-tilt-brush.png" color="#222">
  <meta name="google-site-verification" content="ttIkhAIFZQM9Huj8roB0l95ePN2Tv2zv2wRFksi09WA">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Noto Serif SC:300,300italic,400,400italic,700,700italic|Pacifico:300,300italic,400,400italic,700,700italic|Roboto Slab:300,300italic,400,400italic,700,700italic|Roboto Mono:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">
<link rel="stylesheet" href="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/5.15.2/css/all.min.css">
  <link rel="stylesheet" href="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"imzlp.com","root":"/","scheme":"Pisces","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false,"width":280},"copycode":{"enable":true,"show_result":true,"style":"flat"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":true,"color":"#222","save":"manual"},"fancybox":true,"mediumzoom":false,"lazyload":true,"pangu":true,"comments":{"style":"tabs","active":"valine","storage":true,"lazyload":false,"nav":null,"activeClass":"valine"},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"code_unfold":{"enable":true,"CODE_MAX_HEIGHT":600},"path":"search.xml"};
  </script>

  <meta name="description" content="之前的热更新系列文章中介绍了UE热更新的流程和打包细节，其实有一些热更补丁优化的工程实践我觉得也可以详细介绍。 本篇文章从生成Shader的Patch入手，目的减少每次热更新时的Shader的大小，并会对引擎内部的实现细节做一些分析，解决引擎中的Shader Patch的相关问题，并基于HotPatcher的实现自动化的Shade Patch流程。  2021.11.02 UPDATE：HotPa">
<meta property="og:type" content="article">
<meta property="og:title" content="UE热更新：Create Shader Patch">
<meta property="og:url" content="https://imzlp.com/posts/5867/index.html">
<meta property="og:site_name" content="循迹研究室">
<meta property="og:description" content="之前的热更新系列文章中介绍了UE热更新的流程和打包细节，其实有一些热更补丁优化的工程实践我觉得也可以详细介绍。 本篇文章从生成Shader的Patch入手，目的减少每次热更新时的Shader的大小，并会对引擎内部的实现细节做一些分析，解决引擎中的Shader Patch的相关问题，并基于HotPatcher的实现自动化的Shade Patch流程。  2021.11.02 UPDATE：HotPa">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://img.imzlp.com/imgs/zlp/picgo/2023/20230206152546.webp">
<meta property="article:published_time" content="2021-03-12T09:49:27.000Z">
<meta property="article:modified_time" content="2021-03-12T09:49:27.000Z">
<meta property="article:author" content="查利鹏">
<meta property="article:tag" content="UnrealEngine">
<meta property="article:tag" content="热更新">
<meta property="article:tag" content="HotPatcher">
<meta property="article:tag" content="ShaderPatch">
<meta property="article:tag" content="ushaderbytecode">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img.imzlp.com/imgs/zlp/picgo/2023/20230206152546.webp">

<link rel="canonical" href="https://imzlp.com/posts/5867/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>UE热更新：Create Shader Patch | 循迹研究室</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FDCJ41EFP5"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-FDCJ41EFP5');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.staticfile.org/lxgw-wenkai-screen-webfont/1.7.0/style.min.css" /><!-- hexo injector head_end end --><link rel="alternate" href="/atom.xml" title="循迹研究室" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">循迹研究室</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        
            
  <li class="menu-item menu-item-notes">

    <a href="/notes/" rel="section"><i class="fa fa-edit fa-fw"></i>笔记</a>

  </li>


      
        
            
  <li class="menu-item menu-item-essay">

    <a href="/essay/" rel="section"><i class="fas fa-feather-alt fa-fw"></i>随笔</a>

  </li>


      
        
            
  <li class="menu-item menu-item-resources">

    <a href="/resources/" rel="section"><i class="fa fa-inbox fa-fw"></i>资源</a>

  </li>


      
        <li class="menu-item menu-item-friends">

    <a href="/friends/" rel="section"><i class="fas fa-link fa-fw"></i>友链</a>

  </li>
        
            
  <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>


      
        <li class="menu-item menu-item-showcase">

    <a href="/showcase/" rel="section"><i class="fa fa-solid fa-trophy fa-fw"></i>展示柜</a>

  </li>
        <li class="menu-item menu-item-changelog">

    <a href="/changelog/" rel="section"><i class="fa fa-history fa-fw"></i>站点日志</a>

  </li>
        <li class="menu-item menu-item-opensource">

    <a href="/opensource/" rel="section"><i class="fas fa-code-branch fa-fw"></i>开源项目</a>

  </li>
        <li class="menu-item menu-item-uewiki">

    <a href="https://ue5wiki.com/" rel="noopener" target="_blank"><i class="fab fa-wikipedia-w fa-fw"></i>虚幻知识库</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>站内搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>



<script type="text/javascript">
  let domain='aW16bHAuY29t';
  let domain_str = atob(domain);
  let pathname = location.pathname;
  if (domain_str!= location.host.toLowerCase()){
        console.log(`this host is not safe,jump to https://${domain_str}${pathname}`);
        location.href=`https://${domain_str}${pathname}`;
  }
</script>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>
  <a role="button" class="book-mark-link book-mark-link-fixed"></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"
  >
    <link itemprop="mainEntityOfPage" href="https://imzlp.com/posts/5867/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
      <meta itemprop="name" content="查利鹏">
      <meta itemprop="description" content="唯有热爱可抵岁月漫长。">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="循迹研究室">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          UE热更新：Create Shader Patch<a href="https://github.com/imzlp/blog-md/blob/master/_posts/2021-03-12-5867.md" class="post-edit-link" title="编辑" style="float: right;border-bottom: 0px;" rel="noopener" target="_blank"><i class="fa fa-pen-nib"></i></a>
        </h1>

        

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-03-12 09:49 09:49:27:49" itemprop="dateCreated datePublished" datetime="2021-03-12T09:49:27+00:00">2021-03-12 09:49</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UnrealEngine/" itemprop="url" rel="index"><span itemprop="name">UnrealEngine</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/UnrealEngine/%E7%83%AD%E6%9B%B4%E6%96%B0/" itemprop="url" rel="index"><span itemprop="name">热更新</span></a>
                </span>
            </span>

          
            <span id="/posts/5867/" class="post-meta-item leancloud_visitors" data-flag-title="UE热更新：Create Shader Patch" title="阅读次数">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span class="leancloud-visitors-count"></span>
            </span>
  
  <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>5.1k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>13 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>之前的热更新系列文章中介绍了UE热更新的流程和打包细节，其实有一些热更补丁优化的工程实践我觉得也可以详细介绍。</p>
<p>本篇文章从生成Shader的Patch入手，目的减少每次热更新时的Shader的大小，并会对引擎内部的实现细节做一些分析，解决引擎中的Shader Patch的相关问题，并基于<a target="_blank" rel="noopener" href="https://github.com/hxhb/HotPatcher">HotPatcher</a>的实现自动化的Shade Patch流程。</p>
<blockquote>
<p>2021.11.02 UPDATE：<a target="_blank" rel="noopener" href="https://github.com/hxhb/HotPatcher">HotPatcher</a>已支持对Patch中所有Cook资源编译的Shader收集起来打包为Shader Library，可以替代Shader Patch的机制。详情见文章：<a href="https://imzlp.com/posts/15810/">UE热更新：Shader更新策略</a>。</p>
</blockquote>
<span id="more"></span>

<h3 id="shaderbytecode的生成与加载"><a href="#shaderbytecode的生成与加载" class="headerlink" title="shaderbytecode的生成与加载"></a>shaderbytecode的生成与加载</h3><p>UE在<code>Project Settings</code>-<code>Packaging</code>中提供了<code>Share Material Shader Code</code>的选项，可以控制Shader的共享，存储为单独的文件中，减少包体的大小。</p>
<blockquote>
<p>By default shader code gets saved inline inside material assets, enabling this option will store only shader code once as individual files This will reduce overall package size but might increase loading time.</p>
</blockquote>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/5867/20210312105039.webp"></p>
<p>当开启这个选项之后打包项目，包内的<code>Content</code>目录下会生成以下两个<code>ushaderbytecode</code>文件：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/5867/20210312110129.webp"></p>
<p>打包的Pak中的Mount Point为：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../../../PROJECT_NAME/Content/</span><br></pre></td></tr></table></figure>
<p>而且ushaderbytecode文件的命名根据以下规则：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/RenderCore/Private/ShaderCodeLibrary.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> FString ShaderExtension = <span class="built_in">TEXT</span>(<span class="string">&quot;.ushaderbytecode&quot;</span>);</span><br><span class="line"><span class="type">static</span> FString StableExtension = <span class="built_in">TEXT</span>(<span class="string">&quot;.scl.csv&quot;</span>);</span><br><span class="line"><span class="type">static</span> FString PipelineExtension = <span class="built_in">TEXT</span>(<span class="string">&quot;.ushaderpipelines&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">static</span> FString <span class="title">GetCodeArchiveFilename</span><span class="params">(<span class="type">const</span> FString&amp; BaseDir, <span class="type">const</span> FString&amp; LibraryName, FName Platform)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> BaseDir / FString::<span class="built_in">Printf</span>(<span class="built_in">TEXT</span>(<span class="string">&quot;ShaderArchive-%s-&quot;</span>), *LibraryName) + Platform.<span class="built_in">ToString</span>() + ShaderExtension;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ushaderbytecode在引擎启动时会自动加载，但是注意Global和项目两者加载时机的区别：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Launch/Private/LaunchEngineLoop.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">int32 <span class="title">FEngineLoop::PreInitPreStartupScreen</span><span class="params">(<span class="type">const</span> TCHAR* CmdLine)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">bool</span> bUseCodeLibrary = FPlatformProperties::<span class="built_in">RequiresCookedData</span>() || GAllowCookedDataInEditorBuilds;</span><br><span class="line">    <span class="keyword">if</span> (bUseCodeLibrary)</span><br><span class="line">    &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FShaderCodeLibrary::InitForRuntime&quot;</span>);</span><br><span class="line">        <span class="comment">// Will open material shader code storage if project was packaged with it</span></span><br><span class="line">        <span class="comment">// This only opens the Global shader library, which is always in the content dir.</span></span><br><span class="line">        FShaderCodeLibrary::<span class="built_in">InitForRuntime</span>(GMaxRHIShaderPlatform); <span class="comment">// 加载Global的ushaderbytecode</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">#<span class="keyword">if</span> !UE_EDITOR</span></span><br><span class="line">      <span class="comment">// Cooked data only - but also requires the code library - game only</span></span><br><span class="line">      <span class="keyword">if</span> (FPlatformProperties::<span class="built_in">RequiresCookedData</span>())</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FShaderPipelineCache::Initialize&quot;</span>);</span><br><span class="line">        <span class="comment">// Initialize the pipeline cache system. Opening is deferred until the manual call to</span></span><br><span class="line">        <span class="comment">// OpenPipelineFileCache below, after content pak&#x27;s ShaderCodeLibraries are loaded.</span></span><br><span class="line">        FShaderPipelineCache::<span class="built_in">Initialize</span>(GMaxRHIShaderPlatform);</span><br><span class="line">      &#125;</span><br><span class="line">  <span class="meta">#<span class="keyword">endif</span> <span class="comment">//!UE_EDITOR</span></span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">int32 <span class="title">FEngineLoop::PreInitPostStartupScreen</span><span class="params">(<span class="type">const</span> TCHAR* CmdLine)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="comment">//Handle opening shader library after our EarlyLoadScreen</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">LLM_SCOPE</span>(ELLMTag::Shaders);</span><br><span class="line">    <span class="built_in">SCOPED_BOOT_TIMING</span>(<span class="string">&quot;FShaderCodeLibrary::OpenLibrary&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Open the game library which contains the material shaders.</span></span><br><span class="line">    FShaderCodeLibrary::<span class="built_in">OpenLibrary</span>(FApp::<span class="built_in">GetProjectName</span>(), FPaths::<span class="built_in">ProjectContentDir</span>()); <span class="comment">// 加载项目的ushaderbytecode</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">const</span> FString&amp; RootDir : FPlatformMisc::<span class="built_in">GetAdditionalRootDirectories</span>())</span><br><span class="line">    &#123;</span><br><span class="line">      FShaderCodeLibrary::<span class="built_in">OpenLibrary</span>(FApp::<span class="built_in">GetProjectName</span>(), FPaths::<span class="built_in">Combine</span>(RootDir, FApp::<span class="built_in">GetProjectName</span>(), <span class="built_in">TEXT</span>(<span class="string">&quot;Content&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Now our shader code main library is opened, kick off the precompile, if already initialized</span></span><br><span class="line">    FShaderPipelineCache::<span class="built_in">OpenPipelineFileCache</span>(GMaxRHIShaderPlatform);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>综上所述，引擎打包对于Shader的处理需要注意以下两点：</p>
<ol>
<li>打包项目是会只把当前打包的资源的Shader编译到ushaderbytecode中</li>
<li>引擎启动时会自动加载</li>
</ol>
<p>所以，如果我们进行热更新资源时有shader的变动或者新增了，如果不把shaderbytecode打包进来，会导致有些资源没有效果，如图：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/pak-shadercode-error-in-ue425.webp"></p>
<p>Log中的错误：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/5867/shader-bytecode-error.webp"></p>
<p>这就需要我们去处理更新Shader的情况。</p>
<h3 id="Shader的热更新"><a href="#Shader的热更新" class="headerlink" title="Shader的热更新"></a>Shader的热更新</h3><p>根据前面一小节的介绍，我们知道了打包时会自动把<strong>所打包资源</strong>的Shader生成到ushaderbytecode文件中，当我们热更时新增了材质，需要把新的shader文件给打到pak中，在运行时加载，不然会丢失材质效果。</p>
<p>在<a target="_blank" rel="noopener" href="https://github.com/hxhb/HotPatcher">HotPatcher</a>中提供了包含shaderbytecode的选项，会把Cook之后最新生成的ushaderbytecode打包到pak中：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/5867/20210312124711.webp"></p>
<p>并且Monut Point与基础包的相同。</p>
<p>当我们挂载热更的pak时，需要pak order大于基础包中的pak，这样我们热更的pak中的ushaderbytecode就是优先级最高的，但是因为前面也已经提到了，引擎启动时就已经自动加载了基础包中的shaderbytecode，当程序运行起来之后挂载的pak中的shaderbytecode就不会被自动加载，这需要在挂载pak之后自己执行：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">UFlibPatchParserHelper::ReloadShaderbytecode</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	FShaderCodeLibrary::<span class="built_in">OpenLibrary</span>(<span class="string">&quot;Global&quot;</span>, FPaths::<span class="built_in">ProjectContentDir</span>());</span><br><span class="line">	FShaderCodeLibrary::<span class="built_in">OpenLibrary</span>(FApp::<span class="built_in">GetProjectName</span>(), FPaths::<span class="built_in">ProjectContentDir</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用<code>FShaderCodeLibrary::OpenLibrary</code>函数即可。</p>
<p>综上所述，我们热更shader时的流程如下：</p>
<ol>
<li>执行Cook生成包含最新资源的ushaderbytecode文件</li>
<li>打包ushaderbytecode到pak中</li>
<li>手动加载ushaderbytecode</li>
</ol>
<p>重新生成ushaderbytecode可以直接使用以下cook命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UE4Editor-cmd.exe PROJECT_NAME.uproject -run=cook -targetplatform=WindowsNoEditor -Iterate -UnVersioned -Compressed</span><br></pre></td></tr></table></figure>
<p>其实它会rebuild metadata，AssetRegistry之类的都会重新生成。<br>执行完毕之后<code> Saved/Cooked</code>下的 <code>AssetRegistry.bin</code>以及<code>Metadate</code>目录 <code>/Content/ShaderArchive-*.ushaderbytecode</code>以及 <code>Ending/GlobalShaderCache*.bin</code>等文件都是生成之后最新的了，可以在之后通过 HotPatcher 来打包他们了。</p>
<h3 id="Shader-Patch的生成"><a href="#Shader-Patch的生成" class="headerlink" title="Shader Patch的生成"></a>Shader Patch的生成</h3><p>但是，上一节的介绍其实是每次热更都需要完整地把shaderbytecode更新，其实是有点浪费的，因为基础包中的shader已经存在了，没必要我们每次更新还要把已有的包含进来，而且到项目后期Shader的占用会很大，甚至有的能达到几百M，如果每次资源变动的热更都要包含几百M这肯定是不行的，所以也需要对Shader进行Patch，实现增量更新的目的。</p>
<p>UE中在4.23+中开始提供了创建ShaderPatch的方法，需要提供Old Metadata和New Metadata的目录，<code>Metadata</code>必须要具有以下目录结构：</p>
<figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">D:\Unreal Projects\Blank425\Saved\Cooked\WindowsNoEditor\Blank425\Metadata&gt;tree /a /f</span><br><span class="line">卷 Windows 的文件夹 PATH 列表</span><br><span class="line">卷序列号为 0C49-9EA3</span><br><span class="line">C:.</span><br><span class="line">|   BulkDataInfo.ubulkmanifest</span><br><span class="line">|   CookedIniVersion.txt</span><br><span class="line">|   DevelopmentAssetRegistry.bin</span><br><span class="line">|</span><br><span class="line">\---ShaderLibrarySource</span><br><span class="line">        ShaderArchive-Global-PCD3D_SM5.ushaderbytecode</span><br><span class="line">        ShaderArchive-Blank425-PCD3D_SM5.ushaderbytecode</span><br></pre></td></tr></table></figure>
<p>需要在打基础包时备份好当时的Metadata目录，把最新的工程在执行Cook之后的Metadata目录作为New Metadata，基础包的作为Old Metadata，调用引擎中的<code>FShaderCodeLibrary::CreatePatchLibrary</code>函数，但是这个函数在不同的引擎版本中原型有差异，可以实现一层封装：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UFlibShaderPatchHelper::CreateShaderCodePatch</span><span class="params">(TArray&lt;FString&gt; <span class="type">const</span>&amp; OldMetaDataDirs, FString <span class="type">const</span>&amp; NewMetaDataDir, FString <span class="type">const</span>&amp; OutDir, <span class="type">bool</span> bNativeFormat)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> ENGINE_MINOR_VERSION &gt; 25</span></span><br><span class="line">	<span class="keyword">return</span> FShaderCodeLibrary::<span class="built_in">CreatePatchLibrary</span>(OldMetaDataDirs,NewMetaDataDir,OutDir,bNativeFormat,<span class="literal">true</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	<span class="meta">#<span class="keyword">if</span> ENGINE_MINOR_VERSION &gt; 23</span></span><br><span class="line">		<span class="keyword">return</span> FShaderCodeLibrary::<span class="built_in">CreatePatchLibrary</span>(OldMetaDataDirs,NewMetaDataDir,OutDir,bNativeFormat);</span><br><span class="line">	<span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">	<span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>FShaderCodeLibrary::CreatePatchLibrary</code>内部的实现原理是，从Old Metadata序列化出旧的Shader数据，与New Metadata的做比对，有差异的部分作为Patch中的Shader。</p>
<p>HotPatcher中提供了Shader Patch的配置和管理方法：</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/posts/5867/20210312131743.webp"></p>
<p>可以同时指定多个平台以及Metadata的目录参数，并且支持commandlet。</p>
<h3 id="4-25-ShaderPatch-Crash"><a href="#4-25-ShaderPatch-Crash" class="headerlink" title="4.25+ ShaderPatch Crash"></a>4.25+ ShaderPatch Crash</h3><p><strong>注意</strong>，引擎中提供的<code>FShaderCodeLibrary::CreatePatchLibrary</code>在4.25中有bug，会导致生成Patch时的Crash，下面写一下解决方案。</p>
<p>在4.25引擎版本中调用<code>FShaderCodeLibrary::CreatePatchLibrary</code>来创建ShaderCode Patch会触发check抛异常：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201211125932.webp"></p>
<p>这是因为<code>FEditorShaderCodeArchive</code>的构造函数中调用了ShaderHashTable的Initialize，并给了默认值<code>0x1000</code>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">FEditorShaderCodeArchive</span>(FName InFormat)</span><br><span class="line">    : <span class="built_in">FormatName</span>(InFormat)</span><br><span class="line">    , <span class="built_in">Format</span>(<span class="literal">nullptr</span>)</span><br><span class="line">&#123;</span><br><span class="line">  Format = <span class="built_in">GetTargetPlatformManagerRef</span>().<span class="built_in">FindShaderFormat</span>(InFormat);</span><br><span class="line">  <span class="built_in">check</span>(Format);</span><br><span class="line"></span><br><span class="line">  SerializedShaders.ShaderHashTable.<span class="built_in">Initialize</span>(<span class="number">0x10000</span>);</span><br><span class="line">  SerializedShaders.ShaderMapHashTable.<span class="built_in">Initialize</span>(<span class="number">0x10000</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201211125525.webp"></p>
<p>导致在后续的流程中(<code>FSerializedShaderArchive::Serialize</code>)调用<code>Initialize</code>的时候check失败了(因为HaseSize已经有值了，并不是0，对其再调用Initialize就触发了check)：<br><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/2020/20201211130200.webp"></p>
<p>查了下<code>FEditorShaderCodeArchive</code>构造函数中调用<code>Initialize</code>的代码是在4.25之后的引擎版本才有的，所以影响到的之后4.25+的版本。<br>代码对比：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/4.24.3-release/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L922">4.24.3-release/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L922</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/EpicGames/UnrealEngine/blob/4.25.0-release/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L801">4.25.0-release/Engine/Source/Runtime/RenderCore/Private/ShaderCodeLibrary.cpp#L801</a></li>
</ul>
<p>解决方案：把<code>FSerializedShaderArchive::Serialize</code>中<code>ShaderMapHashTable</code>的<code>Initialize</code>和<code>ShaderHashTable</code>的<code>Initialize</code>在Editor下注释掉，因为<code>FEditorShaderCodeArchive</code>的代码只在Editor下有效，并且是只在生成ShaderPatch时有用。</p>
<p>这就造成了以下几个问题：</p>
<ol>
<li><code>FEditorShaderCodeArchive</code>的构造只有Eidotor并且ShaderPatch是才有用，也就意味着这里写的<code>ShaderMapHashTable</code>的<code>Initialize</code>和<code>ShaderHashTable</code>的<code>Initialize</code>只有在创建ShaderPatch时才会执行</li>
<li>在打基础包时执行Cook会编译shader，但是不会执行FEditorShaderCodeArchive的构造，<code>ShaderMapHashTable</code>的<code>Initialize</code>和<code>ShaderHashTable</code>的<code>Initialize</code>也就不会执行，就需要在使用的地方来调用它们的初始化</li>
</ol>
<p>这也是UE中没有管理好这两个状态的地方：在<code>FEditorShaderCodeArchive</code>和<code>FSerializedShaderArchive::Serialize</code>中都做了Initialize的操作，在打基础包时造成了<code>ShaderMapHashTable</code>和<code>ShaderHashTable</code>的<code>Initialize</code>已经被<code>FEditorShaderCodeArchive</code>初始化的情况下又被<code>FSerializedShaderArchive::Serialize</code>执行了一遍，导致Crash，但是我们又不能粗暴地把任何一处的初始化操作去掉，只能通过检测<code>ShaderMapHashTable</code>和<code>ShaderHashTable</code>的<code>Initialize</code>是否已经被执行，来选择性的跳过。</p>
<p>阅读代码可以知道<code>ShaderMapHashTable</code>和<code>ShaderHashTable</code>的<code>Initialize</code>只应该执行一次，并且初始化之后HashSize和IndexSize应该具有非0值：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/Core/Public/Containers/HashTable.h</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">FORCEINLINE <span class="type">void</span> <span class="title">FHashTable::Initialize</span><span class="params">(uint32 InHashSize, uint32 InIndexSize)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">check</span>(HashSize == <span class="number">0u</span>);</span><br><span class="line">  <span class="built_in">check</span>(IndexSize == <span class="number">0u</span>);</span><br><span class="line"></span><br><span class="line">  HashSize = InHashSize;</span><br><span class="line">  IndexSize = InIndexSize;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">check</span>(HashSize &lt;= <span class="number">0x10000</span>);</span><br><span class="line">  <span class="built_in">check</span>(FMath::<span class="built_in">IsPowerOfTwo</span>(HashSize));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (IndexSize)</span><br><span class="line">  &#123;</span><br><span class="line">    HashMask = (uint16)(HashSize - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    Hash = <span class="keyword">new</span> uint32[HashSize];</span><br><span class="line">    NextIndex = <span class="keyword">new</span> uint32[IndexSize];</span><br><span class="line"></span><br><span class="line">    FMemory::<span class="built_in">Memset</span>(Hash, <span class="number">0xff</span>, HashSize * <span class="number">4</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>Initialize</code>时会检测当前的<code>HashSize</code>和<code>IndexSize</code>是否为0，并在之后进行赋值。所以，我们只要获取<code>FHashTable</code>的<code>HashSize</code>和<code>IndexSize</code>检测它们是否为0即可判断当前的<code>HashTable</code>对象是否已经被<code>Initialize</code>过，但是，UE里的<code>FHashTable</code>里这两个成员都是<code>protected</code>的，只能修改引擎来实现了：</p>
<p>添加获取<code>FHashTable</code>的<code>HashSize</code>和<code>IndexSize</code>属性的成员函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FHashTable</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="function">FORCEINLINE uint32 <span class="title">GetHashSize</span><span class="params">()</span><span class="type">const</span></span>&#123;<span class="keyword">return</span> HashSize;&#125;;</span><br><span class="line">  <span class="function">FORCEINLINE uint32 <span class="title">GetIndexSize</span><span class="params">()</span><span class="type">const</span></span>&#123;<span class="keyword">return</span> IndexSize;&#125;;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>然后在<code>FSerializedShaderArchive::Serialize</code>进行检测，如果已被初始化则跳过<code>Initialize</code>逻辑：</p>
<figure class="highlight cpp"><figcaption><span>Runtime/RenderCore/Private/ShaderCodeArchive.cpp</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">FSerializedShaderArchive::Serialize</span><span class="params">(FArchive&amp; Ar)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  Ar &lt;&lt; ShaderMapHashes;</span><br><span class="line">  Ar &lt;&lt; ShaderHashes;</span><br><span class="line">  Ar &lt;&lt; ShaderMapEntries;</span><br><span class="line">  Ar &lt;&lt; ShaderEntries;</span><br><span class="line">  Ar &lt;&lt; PreloadEntries;</span><br><span class="line">  Ar &lt;&lt; ShaderIndices;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">check</span>(ShaderHashes.<span class="built_in">Num</span>() == ShaderEntries.<span class="built_in">Num</span>());</span><br><span class="line">  <span class="built_in">check</span>(ShaderMapHashes.<span class="built_in">Num</span>() == ShaderMapEntries.<span class="built_in">Num</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (Ar.<span class="built_in">IsLoading</span>())</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">    <span class="keyword">auto</span> ShaderHashInitialized = [](<span class="type">const</span> FHashTable&amp; HashTable)-&gt;<span class="type">bool</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">return</span> HashTable.<span class="built_in">GetHashSize</span>() || HashTable.<span class="built_in">GetIndexSize</span>();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">const</span> uint32 HashSize = FMath::<span class="built_in">Min</span>&lt;uint32&gt;(<span class="number">0x10000</span>, <span class="number">1u</span> &lt;&lt; FMath::<span class="built_in">CeilLogTwo</span>(ShaderMapHashes.<span class="built_in">Num</span>()));</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">      <span class="keyword">if</span>(!<span class="built_in">ShaderHashInitialized</span>(ShaderMapHashTable))</span><br><span class="line">      &#123;</span><br><span class="line">        ShaderMapHashTable.<span class="built_in">Initialize</span>(HashSize, ShaderMapHashes.<span class="built_in">Num</span>());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">for</span> (int32 Index = <span class="number">0</span>; Index &lt; ShaderMapHashes.<span class="built_in">Num</span>(); ++Index)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="type">const</span> uint32 Key = <span class="built_in">GetTypeHash</span>(ShaderMapHashes[Index]);</span><br><span class="line">        ShaderMapHashTable.<span class="built_in">Add</span>(Key, Index);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="type">const</span> uint32 HashSize = FMath::<span class="built_in">Min</span>&lt;uint32&gt;(<span class="number">0x10000</span>, <span class="number">1u</span> &lt;&lt; FMath::<span class="built_in">CeilLogTwo</span>(ShaderHashes.<span class="built_in">Num</span>()));</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">      <span class="keyword">if</span>(!<span class="built_in">ShaderHashInitialized</span>(ShaderHashTable))</span><br><span class="line">      &#123;</span><br><span class="line">        ShaderHashTable.<span class="built_in">Initialize</span>(HashSize, ShaderHashes.<span class="built_in">Num</span>());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ++[SHADER_PATCH][lipengzha]</span></span><br><span class="line">      </span><br><span class="line">      <span class="keyword">for</span> (int32 Index = <span class="number">0</span>; Index &lt; ShaderHashes.<span class="built_in">Num</span>(); ++Index)</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="type">const</span> uint32 Key = <span class="built_in">GetTypeHash</span>(ShaderHashes[Index]);</span><br><span class="line">        ShaderHashTable.<span class="built_in">Add</span>(Key, Index);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样可以统一ShaderPatch和Runtime的HashTable的Initialize流程。</p>
<h3 id="Shader-Patch的自动化流程"><a href="#Shader-Patch的自动化流程" class="headerlink" title="Shader Patch的自动化流程"></a>Shader Patch的自动化流程</h3><p>HotPatcher中支持了Shade Patch的配置化Commandlet功能，可以通过配置文件执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UE4Editor.exe PROJECT.uproject -run=HotShaderPatch -config=<span class="string">&quot;export-shaderpatch-config.json&quot;</span></span><br></pre></td></tr></table></figure>

<p> <code>-config</code> 参数所接收的文件都可以从编辑器中通过插件导出。</p>
<p>并且也支持在命令行上的参数替换，与HotRelease和HotPatcher的Commandlet功能类似，这里不再赘述，可以直接去看HotPatcher的文档介绍：</p>
<ul>
<li><a href="https://imzlp.com/posts/17590/#Commandlet">UE4资源热更打包工具HotPatcher#Commandlet</a></li>
</ul>
<p>只需要管理好项目每次版本的Metadata目录，就可以编辑一份通用的配置文件导出，在每次HotPatcher的Patch任务前执行生成Shader的Patch文件，以外部文件的形式添加至HotPatcher的配置中即可。剩下的事情就是运行时加载Shader Patch的文件了，插件中同样做了函数库的支持：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">bool</span> <span class="title">UFlibPatchParserHelper::LoadShaderbytecode</span><span class="params">(<span class="type">const</span> FString&amp; LibraryName, <span class="type">const</span> FString&amp; LibraryDir)</span></span>;</span><br></pre></td></tr></table></figure>

<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>在Shader Patch的使用中需要注意的是：生成出来的ShaderPatch的<code>ushaderbytecode</code>文件是与基础包内的文件名一致的，所以不能使用引擎启动时的默认挂载（会导致基础包内的ushaderbytecode文件无法被加载，从而crash）。</p>
<p><img data-src="https://img.imzlp.com/imgs/zlp/blog/notes/ue/index/UE4/auto-mount-shaderpatch-crash.webp"></p>
<p>应该按照前文的介绍在挂载之后自己处理ShaderPatch的ushaderbytecode文件的加载。</p>
<p><strong>并且</strong>：ShaderPatch的更新不<strong>直接支持</strong>Patch的迭代，如：1.0 Metadata + 1.1的ShaderPatch，并不能生成1.2的ShaderPatch，必须要基于1.1的完整Metadata才可以，即每次Patch必须要基于上一次完整的Metadate数据（Project和Global的ushaderbytecode文件），在工程管理上每次打包都需要把完整的Metadata收集起来。</p>

    </div>

    
    
        
        
          
            <blockquote class="blockquote-center">
              
                全文完，若有不足之处请评论指正。
              
            <br/>
            
                <div class="qr-code" onclick="return false">
                    <script src="/js/qrcode.min.js"></script>
                    <div id="qrcode">
                      
                        <img src="https://imzlp.com/images/wechat-qrcode.webp">
                      
                    <p>微信扫描二维码，关注我的公众号。</p>
                    </div>
                </div>
            
            </blockquote>
          
        

        
          <div class="postCopyright" style="clear:both;">
             <span>本文标题:</span><a href="/posts/5867/" target="_blank">UE热更新：Create Shader Patch</a><br/>
             <span>文章作者:</span><a href="/about" target="_blank" title="查看 查利鹏 的资料">查利鹏</a><br/>
             <span>发布时间:</span>2021年03月12日 09时49分<br/>
             
             <span>本文字数:</span><span class="page-count">本文一共有5.1k字</span><br/>
             
             <span>原始链接:</span><a href="/posts/5867/" target="_blank" title="UE热更新：Create Shader Patch">https://imzlp.com/posts/5867/</a>
             <span class="copy-path" data-clipboard-text="原文链接: https://imzlp.com/posts/5867/ 作者: 查利鹏" title="点击复制文章链接"><i class="fa fa-clipboard"></i></span>
             <script src="/js/jquery.min.js"></script>
             <script src="/js/clipboard.min.js"></script>
             <script> var clipboard = new Clipboard('.copy-path'); </script>
             <br/>
             
             <span>许可协议:</span><i class="fab fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" title="Attribution-NonCommercial-ShareAlike 4.0 International">CC BY-NC-SA 4.0</a><br/>
             
             <span>文章禁止全文转载，摘要转发请保留原文链接及作者信息，谢谢！</span>
          </div>
        
    
        
  <div class="reward-container">
    <div>您的捐赠将鼓励我继续创作！</div>
    <button onclick="var qr = document.getElementById('qr'); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
      打赏
    </button>
    <div id="qr" style="display: none;">
        
        <div style="display: inline-block;">
          <img src="/images/reward/wechatpay.webp" alt="查利鹏 微信支付">
          <p>微信支付</p>
        </div>

    </div>
  </div>



      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/UnrealEngine/" rel="tag"># UnrealEngine</a>
              <a href="/tags/%E7%83%AD%E6%9B%B4%E6%96%B0/" rel="tag"># 热更新</a>
              <a href="/tags/HotPatcher/" rel="tag"># HotPatcher</a>
              <a href="/tags/ShaderPatch/" rel="tag"># ShaderPatch</a>
              <a href="/tags/ushaderbytecode/" rel="tag"># ushaderbytecode</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/16895/" rel="prev" title="UE热更新：Questions & Answers">
      <i class="fa fa-chevron-left"></i> UE热更新：Questions & Answers
    </a></div>
      <div class="post-nav-item">
    <a href="/posts/9780/" rel="next" title="UE反射实现分析：反射代码生成（一）">
      UE反射实现分析：反射代码生成（一） <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
      <div class="tabs tabs-comment">
        <ul class="nav-tabs">
            <li class="tab"><a href="#comment-utteranc">utteranc</a></li>
            <li class="tab"><a href="#comment-valine">valine</a></li>
        </ul>
        <div class="tab-content">
            <div class="tab-pane utteranc" id="comment-utteranc">
              
  
  <div class="comments">
  <script src="https://utteranc.es/client.js" repo="hxhb/blog-comments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async></script>
  </div>
  
  
            </div>
            <div class="tab-pane valine" id="comment-valine">
              <div class="comments" id="valine-comments"></div>
            </div>
        </div>
      </div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#shaderbytecode%E7%9A%84%E7%94%9F%E6%88%90%E4%B8%8E%E5%8A%A0%E8%BD%BD"><span class="nav-number">1.</span> <span class="nav-text">shaderbytecode的生成与加载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Shader%E7%9A%84%E7%83%AD%E6%9B%B4%E6%96%B0"><span class="nav-number">2.</span> <span class="nav-text">Shader的热更新</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Shader-Patch%E7%9A%84%E7%94%9F%E6%88%90"><span class="nav-number">3.</span> <span class="nav-text">Shader Patch的生成</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-25-ShaderPatch-Crash"><span class="nav-number">4.</span> <span class="nav-text">4.25+ ShaderPatch Crash</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Shader-Patch%E7%9A%84%E8%87%AA%E5%8A%A8%E5%8C%96%E6%B5%81%E7%A8%8B"><span class="nav-number">5.</span> <span class="nav-text">Shader Patch的自动化流程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9"><span class="nav-number">6.</span> <span class="nav-text">注意事项</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person" oncontextmenu="return false" οndragstart="return false">
    <img class="site-author-image" itemprop="image" alt="查利鹏"
      src="https://img.imzlp.com/imgs/zlp/picgo/2023/202304152112902.webp">
  <p class="site-author-name" itemprop="name">查利鹏</p>
  <div class="site-description" itemprop="description">唯有热爱可抵岁月漫长。</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
             
          <span class="site-state-item-count">189</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
        <span class="site-state-item-count">94</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">188</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/hxhb" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;hxhb" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://linkedin.com/in/lipengzha" title="Linkedin → https:&#x2F;&#x2F;linkedin.com&#x2F;in&#x2F;lipengzha" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.zhihu.com/people/imzlp" title="知乎 → https:&#x2F;&#x2F;www.zhihu.com&#x2F;people&#x2F;imzlp" rel="noopener" target="_blank"><i class="fa fa-custom zhihu fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/images/wechat-qrcode-offical.webp" title="微信公众号 → &#x2F;images&#x2F;wechat-qrcode-offical.webp"><i class="fab fa-weixin fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:imzlp@foxmail.com" title="E-Mail → mailto:imzlp@foxmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i></a>
      </span>
      <span class="links-of-author-item">
        <a href="/atom.xml" title="RSS → &#x2F;atom.xml"><i class="fa fa-rss fa-fw"></i></a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://consolehelp.imzlp.com/" title="https:&#x2F;&#x2F;consolehelp.imzlp.com&#x2F;" rel="noopener" target="_blank">UE Console Help</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/opensource/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;opensource&#x2F;">Open Source Projects</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://imzlp.com/posts/11515/" title="https:&#x2F;&#x2F;imzlp.com&#x2F;posts&#x2F;11515&#x2F;">UE C++ API Dash Documents</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://ue5wiki.com/" title="https:&#x2F;&#x2F;ue5wiki.com&#x2F;" rel="noopener" target="_blank">Unreal Engine Wiki</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        
  <div class="beian"><a href="https://beian.miit.gov.cn/" rel="noopener" target="_blank">粤ICP备2021027036号 </a>
      <img src="/images/beian_logo.webp" style="display: inline-block;"><a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=44030502007298" rel="noopener" target="_blank">粤公网安备44030502007298号 </a>
  </div>

<div class="copyright">
  
  &copy; 2014 – 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">查利鹏</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="站点总字数">747k</span>
</div>
  <div class="powered-by-other">
    
	    <center>Github Pages | Actions | NeXT | Cloudflare | Hexo Deploy</center>
      
  </div>

<script>
function checkWebp(callback) {
    var img = new Image();
    img.onload = function () { callback((img.width > 0) && (img.height > 0)); };
    img.onerror = function () { callback(false); };
    img.src = 'data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA';
}
function showImage(useWebp) {
    var imgs = [].slice.call(document.querySelectorAll('img'));
    imgs.forEach(function (e) {
        if (!useWebp) {
            var src = e.getAttribute('data-src')
            src = src.replace(/\.webp$/, '.png');
            e.setAttribute('data-src', src);
        }
    });
}
checkWebp(showImage);
</script>

        








      </div>
    </footer>
  </div>

  
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/animejs/3.2.1/anime.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.5.1/jquery.min.js"></script>
  <script src="//lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/lozad.js/1.16.0/lozad.min.js"></script>
  <script src="//lf9-cdn-tos.bytecdntp.com/cdn/expire-1-M/pangu/4.0.7/pangu.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>

<script src="/js/bookmark.js"></script>



<script src="/js/code-unfold.js"></script>

  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>









<script>
document.querySelectorAll('.pdfobject-container').forEach(element => {
  let url = element.dataset.target;
  let pdfOpenParams = {
    navpanes : 0,
    toolbar  : 0,
    statusbar: 0,
    pagemode : 'thumbs',
    view     : 'FitH'
  };
  let pdfOpenFragment = '#' + Object.entries(pdfOpenParams).map(([key, value]) => `${key}=${encodeURIComponent(value)}`).join('&');
  let fullURL = `/lib/pdf/web/viewer.html?file=${encodeURIComponent(url)}${pdfOpenFragment}`;

  if (NexT.utils.supportsPDFs()) {
    element.innerHTML = `<embed class="pdfobject" src="${url + pdfOpenFragment}" type="application/pdf" style="height: ${element.dataset.height};">`;
  } else {
    element.innerHTML = `<iframe src="${fullURL}" style="height: ${element.dataset.height};" frameborder="0"></iframe>`;
  }
});
</script>


<script>
if (document.querySelectorAll('pre.mermaid').length) {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js', () => {
    mermaid.initialize({
      theme    : 'forest',
      logLevel : 3,
      flowchart: { curve     : 'linear' },
      gantt    : { axisFormat: '%m/%d/%Y' },
      sequence : { actorMargin: 50 }
    });
  }, window.mermaid);
}
</script>


  

  

  
  <script src="//img.imzlp.com/imgs/zlp/picgo/2021/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri === 'https://imzlp.com/posts/5867/',]
      });
      });
  </script>


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/valine/1.4.14/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    var requiredFields = 'nick';
    requiredFields = requiredFields.split(',');
    
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : 'oCE6RMVkVoi5MgUhvFsn1EvV-gzGzoHsz',
      appKey     : 'K9SOaNYJ8PV6xaoFggWG5xvv',
      placeholder: "留下点什么吧~",
      avatar     : 'robohash',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : true,
      lang       : '' || 'zh-cn',
      path       : location.pathname,
      recordIP   : true,
      serverURLs : '',
      requiredFields: requiredFields
    });
  }, window.Valine);
});
</script>

</body>
</html>
